<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: 0.5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
    </style>
  </head>
  <body>
    <ul id="messages"></ul>
    <form action="">
      <p style="color:white" id="areTyping"></p>
      <!-- <select name="channel" id="channel-select">
        <option value="channel1">channel1</option>
        <option value="channel2">channel2</option>
        <option value="channel3">channel3</option>
    </select> -->
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>
    <script src="socket.io/socket.io.js"></script>
    <script>

      const form = document.querySelector("form");
      const input = form.querySelector("input");
      const typerElement = document.getElementById("areTyping");
      let userTyping = [];
      let timeout = null;

      const username = Math.random().toString(36).substring(7);

      let socket = io();

      const appendChatMessage = (user, content) => {
        const messageList = document.querySelector("ul");
        messageList.insertAdjacentHTML("beforeend", `<li>${user} <small>said</small> ${content}</li>`);
      }

      const appendIOMessage = (user, connectionState) => {
        const messageList = document.querySelector("ul");
        const item = connectionState ? `<li>${user} joined</li>` : `<li>${user} left</li>`;
        messageList.insertAdjacentHTML("beforeend", item);
      }

      const renderTyper = () => {
        
        uTLength = userTyping.length;
        
        const typings = userTyping.map((e, i) => {
          if(uTLength == 1) return `${e} is typing...`;
          if(i ==  uTLength - 2) return `${e} and `;
          if(i == uTLength - 1) return  `${e} are typing`;
          if(i < uTLength - 2) return  `${e}, `;
        }).join("");

        typerElement.innerHTML = typings;
      };

      // Js Events
      window.addEventListener("DOMContentLoaded", () => socket.emit("add user", username));
      
      input.addEventListener("keyup", () => {
        socket.emit("typing", username);
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          socket.emit("stop typing");
        }, 5000);
      });

      form.addEventListener("submit", e => {
        e.preventDefault();
        socket.emit("chat message", {
          user: username,
          content: input.value
        });
        appendChatMessage("YOU", input.value);
        input.value = "";
      });

      // Socket events
      socket.on("new message", obj => appendChatMessage(obj.user, obj.content));
      socket.on("user joined", user => appendIOMessage(user.username, true));
      socket.on("user left", user => appendIOMessage(user.username, false));

      socket.on("typing", username => {
        if(!userTyping.includes(username)){
          userTyping.push(username);
          renderTyper();
        }
      });

      socket.on("stop typing", username => {
        userTyping = userTyping.length > 1 ? userTyping.splice(userTyping.indexOf(username), 1) : [];
        renderTyper();
      });
    </script>
  </body>
</html>