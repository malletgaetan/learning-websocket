<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: 0.5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
      #user-list { list-style-type: none; margin: 0; padding: 0; }
    </style>
  </head>
  <body>
    <ul id="user-list"></ul>
    <ul id="messages"></ul>
    <form action="">
      <p style="color:white" id="areTyping"></p>
      <!-- <select name="channel" id="channel-select">
        <option value="channel1">channel1</option>
        <option value="channel2">channel2</option>
        <option value="channel3">channel3</option>
    </select> -->
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>
    <script src="socket.io/socket.io.js"></script>
    <script>
      const form = document.querySelector("form");
      const input = form.querySelector("input");
      const typerElement = document.getElementById("areTyping");
      const usersListElement = document.getElementById("user-list");
      let userTyping = [];
      let localUserList = [];

      const username = Math.random().toString(36).substring(7);

      let socket = io();

      const appendChatMessage = (user, content) => {
        const messageList = document.querySelector("ul");
        messageList.insertAdjacentHTML("beforeend", `<li>${user} <small>said</small> ${content}</li>`);
      };

      const appendIOMessage = (user, connectionState) => {
        const messageList = document.querySelector("ul");
        const item = connectionState ? `<li>${user} joined</li>` : `<li>${user} left</li>`;
        messageList.insertAdjacentHTML("beforeend", item);
      };

      const appendPrivateMessage = (user, content) => {
        const messageList = document.querySelector("ul");
        messageList.insertAdjacentHTML("beforeend", `<li>${user} <small>whispered</small> ${content}</li>`);
      };

      const appendErrorMessage = err => {
        const messageList = document.querySelector("ul");
        messageList.insertAdjacentHTML("beforeend", `<li>${err}</li>`)
      };

      const renderTyper = () => {
        
        console.log(userTyping);

        uTLength = userTyping.length;
        
        //try with a reduce
        const typings = userTyping.map((e, i) => {
          if(uTLength == 1) return `${e} is typing...`;
          if(i ==  uTLength - 2) return `${e} and `;
          if(i == uTLength - 1) return  `${e} are typing`;
          if(i < uTLength - 2) return  `${e}, `;
        }).join("");

        typerElement.innerHTML = typings;
      };

      const setUserList = userList => {
        localUserList = userList;
        usersListElement.innerHTML = "";
        usersListElement.innerHTML = userList.map(e => `<li>${e}</li>`).join('');
      };

      // Js Events
      window.addEventListener("DOMContentLoaded", () => socket.emit("add user", username));

      input.addEventListener("keyup", () => {
        socket.emit("typing", username);
      });

      form.addEventListener("submit", e => {
        e.preventDefault();
        const message = input.value;
        if(message.startsWith('/w ')){
          const destruct = message.split(" ");
          if(localUserList.includes(destruct[1])){
            socket.emit("private message", {
              from: username,
              to: destruct[1],
              message: destruct.slice(2, destruct.length).join(" ")
            });
          } else {
            appendErrorMessage("Sorry but this pseudo doesn't exist.");
          }
        } else {
          socket.emit("chat message", {
            user: username,
            content: input.value
          });
          appendChatMessage("YOU", input.value);
        }
        input.value = "";
      });

      // Socket events
      socket.on("new message", obj => appendChatMessage(obj.user, obj.content));

      socket.on("user joined", income => {
        appendIOMessage(income.username, true);
        setUserList(income.userList);
      });

      socket.on("user left", income => {
        appendIOMessage(income.username, false);
        setUserList(income.userList);
      });

      socket.on("userlist", userList => setUserList(userList));

      socket.on("typing", username => {
        if(!userTyping.includes(username)){
          userTyping.push(username);
          renderTyper();
        }
      });

      socket.on("stop typing", username => {
        console.log(username);
        userTyping.splice(userTyping.indexOf(username), 1);
        renderTyper();
      });

      socket.on("private message", obj => appendPrivateMessage(obj.from, obj.message));
    </script>
  </body>
</html>